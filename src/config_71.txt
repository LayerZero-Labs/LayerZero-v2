TODO: Refactor the main logic.
